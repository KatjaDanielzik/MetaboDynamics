---
title: "how_to_build_a_package"
author: "Katja Danielzik"
date: "2024-08-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

---
title: "Creating_packages"
author: "Katja Danielzik"
date: "2024-08-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This is a follow along of the bock "R packages: 2nd edition" by Hadley Wickham
and Jennifer Bryan (https://r-pkgs.org/).

# System setup
install current R version (4.4.1)
```{bash}
# update indices
sudo apt update -qq
# install two helper packages we need
sudo apt install --no-install-recommends software-properties-common dirmngr
# add the signing key (by Michael Rutter) for these repos
# To verify key, run gpg --show-keys /etc/apt/trusted.gpg.d/cran_ubuntu_key.asc 
# Fingerprint: E298A3A825C0D65DFD57CBB651716619E084DAB9
wget -qO- https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc | sudo tee -a /etc/apt/trusted.gpg.d/cran_ubuntu_key.asc
# add the R 4.0 repo from CRAN -- adjust 'focal' to 'groovy' or 'bionic' as needed
sudo add-apt-repository "deb https://cloud.r-project.org/bin/linux/ubuntu $(lsb_release -cs)-cran40/"
# install base r
sudo apt install r-base
# install development tools
sudo apt install r-base-dev
```

## install necessary packages 
```{r}
install.packages(c("devtools","roxygen2","testthat","knitr"))
library(devtools)
# attach devtools for every R session
if (interactive()) {
  suppressMessages(require(devtools))
}
```

## check if necessary packages are installed
```{r}
devtools::dev_sitrep()
```
── R ────────────────────────────────────────────────────────────────────────────────────────────────
• version: 4.4.1
• path: '/usr/lib/R/'
── RStudio ──────────────────────────────────────────────────────────────────────────────────────────
• version: 2024.4.2.764
── devtools ─────────────────────────────────────────────────────────────────────────────────────────
• version: 2.4.5
── dev package ──────────────────────────────────────────────────────────────────────────────────────
• package: <unset>
• path: <unset>
✔ All checks passed

## Git repository
create a new folder and a new git repository, initial git in the folder and set
the git repository to 
Disable automatic workspace save: tools > global options > Restore .RData uncheck,
Save workspace to .RData -> change to "never"
Go to terminal in RStudio 
```{bash}
git config --global credential.helper store
# confirmation with 
git config credential.helper
```
store

```{bash}
# I am using a local credential helper here for this project as I am normally
# pushing to gitlab, if global than "git config --global ..."
git config user.name "KatjaDanielzik"
git config user.email "katja.danielzik@uni-due.de"
```

create a token for the current github project https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens

```{r}
install.packages("gitcreds")

gitcreds::gitcreds_set()
```
Show in New Window

-> Your current credentials for 'https://github.com':

  protocol: https
  host    : github.com
  username: PersonalAccessToken
  password: <-- hidden -->

-> What would you like to do? 

1: Abort update with error, and keep the existing credentials
2: Replace these credentials
3: See the password / token

can also be used to see the password/token

# Building a toy package
devtools package is a public face set of packages that support package development
## creating a package
```{r}
library(devtools)
# initialize a new package in a directory 
create_package("/media/home/MetaboDynamics")
```

## use git
```{r}
use_git()
```
✔ Setting active project to "/media/home/MetaboDynamics".
✔ Adding ".Rhistory", ".Rdata", ".httr-oauth", ".DS_Store", and ".quarto" to .gitignore.
ℹ There are 6 uncommitted files:
• .gitignore
• .Rbuildignore
• DESCRIPTION
• how_to_create_a_package.Rmd
• MetaboDynamics.Rproj
• NAMESPACE
! Is it ok to commit them?

1: Definitely
2: No
3: Not now

Selection: 1
✔ Adding files.
✔ Making a commit with message "Initial commit".

## first function
### define function
```{r}
strsplit1 <- function(x,split){
  strsplit(x,split=split)[[1]]
}
```
### save in an R file
```{r}
use_r("strplit1")
```

put definition of the function and NOTHING else in the file and then save.

### make function available
usually we would just source the R script in the global enviroment, but not 
in package development
```{r}
load_all()
```
makes all functions availale (not in the global enviroment) and simulates the process
 of building, installing, and attaching the new package. 
```{r}
exists("strsplit1",where=globalenv(),inherits=F)
```
[1] FALSE

commit (after every step) and eventually push function via the GIT menu in RStudio

### check function
```{r}
check()
```
checks should be run often !
Show in New Window
══ Documenting ═════════════════════════════════════════════════════════════════════════════════════════════════
ℹ Updating MetaboDynamics documentation
ℹ Loading MetaboDynamics

══ Building ════════════════════════════════════════════════════════════════════════════════════════════════════
Setting env vars:
• CFLAGS    : -Wall -pedantic -fdiagnostics-color=always
• CXXFLAGS  : -Wall -pedantic -fdiagnostics-color=always
• CXX11FLAGS: -Wall -pedantic -fdiagnostics-color=always
• CXX14FLAGS: -Wall -pedantic -fdiagnostics-color=always
• CXX17FLAGS: -Wall -pedantic -fdiagnostics-color=always
• CXX20FLAGS: -Wall -pedantic -fdiagnostics-color=always
── R CMD build ─────────────────────────────────────────────────────────────────────────────────────────────────
✔  checking for file ‘/media/home/MetaboDynamics/DESCRIPTION’ ...
─  preparing ‘MetaboDynamics’:
✔  checking DESCRIPTION meta-information
─  checking for LF line-endings in source and make files and shell scripts
─  checking for empty or unneeded directories
   Removed empty directory ‘MetaboDynamics/man’
─  building ‘MetaboDynamics_0.0.0.9000.tar.gz’
   
══ Checking ════════════════════════════════════════════════════════════════════════════════════════════════════
Setting env vars:
• _R_CHECK_CRAN_INCOMING_USE_ASPELL_           : TRUE
• _R_CHECK_CRAN_INCOMING_REMOTE_               : FALSE
• _R_CHECK_CRAN_INCOMING_                      : FALSE
• _R_CHECK_FORCE_SUGGESTS_                     : FALSE
• _R_CHECK_PACKAGES_USED_IGNORE_UNUSED_IMPORTS_: FALSE
• NOT_CRAN                                     : true
── R CMD check ─────────────────────────────────────────────────────────────────────────────────────────────────
─  using log directory ‘/tmp/RtmpqgnxA6/filefc6e22285322/MetaboDynamics.Rcheck’
─  using R version 4.4.1 (2024-06-14)
─  using platform: x86_64-pc-linux-gnu
─  R was compiled by
       gcc (Ubuntu 11.4.0-1ubuntu1~22.04) 11.4.0
       GNU Fortran (Ubuntu 11.4.0-1ubuntu1~22.04) 11.4.0
─  running under: Ubuntu 22.04.2 LTS
─  using session charset: UTF-8
─  using options ‘--no-manual --as-cran’
✔  checking for file ‘MetaboDynamics/DESCRIPTION’
─  this is package ‘MetaboDynamics’ version ‘0.0.0.9000’
─  package encoding: UTF-8
✔  checking package namespace information
✔  checking package dependencies (655ms)
✔  checking if this is a source package
✔  checking if there is a namespace
✔  checking for executable files
✔  checking for hidden files and directories
✔  checking for portable file names
✔  checking for sufficient/correct file permissions
✔  checking serialization versions
✔  checking whether package ‘MetaboDynamics’ can be installed (785ms)
✔  checking installed package size ...
✔  checking package directory
✔  checking for future file timestamps (489ms)
W  checking DESCRIPTION meta-information ...
   Non-standard license specification:
     `use_mit_license()`, `use_gpl3_license()` or friends to pick a
     license
   Standardizable: FALSE
N  checking top-level files
   Non-standard file/directory found at top level:
     ‘how_to_create_a_package.Rmd’
✔  checking for left-over files
✔  checking index information
✔  checking package subdirectories ...
✔  checking code files for non-ASCII characters ...
✔  checking R files for syntax errors ...
✔  checking whether the package can be loaded ...
✔  checking whether the package can be loaded with stated dependencies ...
✔  checking whether the package can be unloaded cleanly ...
✔  checking whether the namespace can be loaded with stated dependencies ...
✔  checking whether the namespace can be unloaded cleanly ...
✔  checking loading without being on the library search path ...
✔  checking dependencies in R code ...
✔  checking S3 generic/method consistency ...
✔  checking replacement functions ...
✔  checking foreign function calls ...
✔  checking R code for possible problems (1.8s)
✔  checking for missing documentation entries ...
─  checking examples ... NONE
✔  checking for non-standard things in the check directory
✔  checking for detritus in the temp directory
   
   See
     ‘/tmp/RtmpqgnxA6/filefc6e22285322/MetaboDynamics.Rcheck/00check.log’
   for details.
   
── R CMD check results ────────────────────────────────────────────────────────── MetaboDynamics 0.0.0.9000 ────
Duration: 6.8s

❯ checking DESCRIPTION meta-information ... WARNING
  Non-standard license specification:
    `use_mit_license()`, `use_gpl3_license()` or friends to pick a
    license
  Standardizable: FALSE

❯ checking top-level files ... NOTE
  Non-standard file/directory found at top level:
    ‘how_to_create_a_package.Rmd’

0 errors ✔ | 1 warning ✖ | 1 note ✖

## edit description
edit "DESCRIPTION" file 

## set a licencse
to choose a copyleft license (allows to freely copy and modify code for personal
use but if you publish modified versions or bundle with other code, the modified
version or complete bundle must also be licensed with the GPL)
```{r}
use_gpl_license()
# minimal restrictions
# use_mit_license()
```

✔ Adding "GPL (>= 3)" to License.
✔ Writing LICENSE.md.
✔ Adding "^LICENSE\\.md$" to .Rbuildignore.

## document
for future users to get help with the functions a R documentation file "man/strsplit1.Rd"
is needed. Written in R-specific markup language. We let roxygen2 handle the creation 
of this file. Go into the function definition with the cursor: code>insert roxygen skeleton
and fill it out.
```{r}
document()
```
ℹ Updating MetaboDynamics documentation
ℹ Loading MetaboDynamics
✖ strplit1.R:3: @param requires two parts: an argument name and a description.
✖ strplit1.R:9: @examples requires a value.
Writing NAMESPACE
Writing strsplit1.Rd

this should add man/strsplit1.Rd and add export(strsplit1) in the "NAMESPACE"
file
```{r}
help("strsplit1")
```
should open the help page of the function
after re-checking again we can now install the package into our library

## install 
```{r}
install()
library(MetaboDynamics)
```

# test functions
we can formalize tests for functions in unit tests with 
```{r}
# declare intent to write unite tests and use testthat package
use_testthat(3)
# open and/or create test file
use_test("strsplit1")
```



this creates a folder "tests" with subfolder "testthat" and "testthat.R"
✔ Adding testthat to Suggests field in DESCRIPTION.
✔ Adding "3" to Config/testthat/edition.
✔ Creating tests/testthat/.
✔ Writing tests/testthat.R.
☐ Call usethis::use_test() to initialize a basic test file and open it for editing.

use_test("functionname") creates a file test-functionname.R and returns
✔ Writing tests/testthat/test-strsplit1.R.
☐ Modify tests/testthat/test-strsplit1.R.
```{r}
# run tests
test()

# tests also run whenever one uses check()
check()
```
ℹ Testing MetaboDynamics
✔ | F W  S  OK | Context
✔ |          1 | strsplit1                                                                                      

══ Results ═════════════════════════════════════════════════════════════════════════════════════════════════════
[ FAIL 0 | WARN 0 | SKIP 0 | PASS 1 ]

# use other packages
we have to declare other packages we need with package specific methods. 
When submitting to CRAN that even applies to functions in packages such as 
"stats" and "utils".
It adds the package to the "DESCRIPTION" file under "Imports". That means
that the package will be installed along with your own package, but not loaded
(library()) into the enviroment. This needs still to be done in the functions or
used as stringr::. Operatorators such as %>% cannot be accessed behind stringr::
so the corresponding package has to be loaded beforehand.

For our package we will need strinr, rstan, ggplot, dplyr I think.
Bayesplot not necessary but it makes it easier for the user to inspect
the resulting modelling files -> suggested
```{r}
use_package("stringr", "imports",min_version=TRUE) # min_version=TRUE sets to current version
use_package("rstan","imports",min_version = TRUE)
use_package("ggplot2","imports",min_version=TRUE)
use_package("bayesplot","suggests",min_version=TRUE)
```
✔ Adding stringr to Imports field in DESCRIPTION.
☐ Refer to functions with `stringr::fun()`.

# create welcome mats to the package
## README on github
The "README.md" file is the package's hoem page and welcome mat. 
Additionally one create a website, vignette or submit to CRAN.
```{r}
# intitializes a basic executable README.Rmd that can be edited
use_readme_rmd()
# building happens with
build_readme()
```
Registered S3 method overwritten by 'rmarkdown':
  method         from
  print.paged_df     
✔ Setting active project to "/media/home/MetaboDynamics".
✔ Writing README.Rmd.
✔ Adding "^README\\.Rmd$" to .Rbuildignore.
☐ Modify README.Rmd.
✔ Writing .git/hooks/pre-commit.


ℹ Installing MetaboDynamics in temporary library
ℹ Building /media/home/MetaboDynamics/README.Rmd
It creates a file "README.Rmd" that can be edited by the author.

## Vignettes
Vignettes are long-form guides to a package. Function documentation is needed
but Vignettes can be framed around a target problem the package was designed
to solve. So it is perfect to a show a workflow that solves a particular 
problem start to finish.
Vignettes can be accessed by "browseVignettes(packagename)"
```{r}
# create a first Vignette
use_vignette("MetaboDynamics")
```
✔ Adding knitr to Suggests field in DESCRIPTION.
✔ Adding rmarkdown to Suggests field in DESCRIPTION.
✔ Adding "knitr" to VignetteBuilder.
✔ Adding "inst/doc" to .gitignore.
✔ Creating vignettes/.
✔ Adding "*.html" and "*.R" to vignettes/.gitignore.
✔ Writing vignettes/MetaboDynamics.Rmd.
☐ Modify vignettes/MetaboDynamics.Rmd.

and creates the file "MetaboDynamics.Rmd" that we can now edit.

Vignettes are only rendered using the currently installed version of a package!!!
That is because of the intial call of "library(packagename)".
So the current version has to be installed with devtools::install()
```{r}
# install package and request Vignette build
devtools::install(build_vignettes = TRUE)
browseVignettes("MetaboDynamics")

# OR USE DEVTOOLS 
build_rmd("vignettes/MetaboDynamics.Rmd")
```
ℹ Installing MetaboDynamics in temporary library
ℹ Building /media/home/MetaboDynamics/vignettes/MetaboDynamics.Rmd


