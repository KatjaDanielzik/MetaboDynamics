---
title: "MetaboDynamics: a worked example"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MetaboDynamics}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Here we want to show a complete workflow to analyze concentration tables.
As example we have a data set of irradiated cancer cells lines that were observed
over four timepoints.
This package was built to faciliate the analysis of longitudinal metabolomics
data. Common tools mostly only allow the comparison between two timepoints or
experimental conditions and are using frequentist statistical methods. As 
metabolomics data is often noise robust methods for the estimation of dynamics
are needed. We employ a hierachical Bayesian model for that. 

## setup: load required packages
```{r setup}
library(MetaboDynamics)
library(ggplot2)
library(dplyr)
library(tidyr)
```

## load data and plot data overview
```{r,fig.align='center',fig.dpi=150}
data("intra")
ggplot(intra, aes(x = cpc)) +
  geom_density() +
  theme_bw() +
  facet_grid(cols = vars(time), rows = vars(dose)) +
  ggtitle("raw data", "cpc values")
```
We can see that there are only measurements at 0h for the 0Gy dose. As this
is the control before irradiation the 0h measurement also is valid for the 2Gy 
and 10Gy group. Furthermore we can see that the cpc values are not distributed
normally.
So let's assign the 0h values also to 2Gy and 10 Gy and log-transform.
```{r,fig.align='center',fig.dpi=150}
# we are taking t=0h for every radiation dose
# we will duplicate the measurements for 0h for 2Gy and 10Gy
temp <- intra[intra$time == "0h", ]
temp$dose <- "2Gy"
temp2 <- temp
temp2$dose <- "10Gy"
intra <- rbind(intra, temp, temp2)
rm(temp, temp2)
intra <- intra %>% mutate(log_cpc = log10(cpc))

# we standardize to a mean of zero and a standard deviation of one of log-transformed data
ggplot(intra, aes(x = log_cpc)) +
  geom_density() +
  theme_bw() +
  facet_grid(cols = vars(time), rows = vars(dose)) +
  ggtitle("data", "log(cpc) values")
```
That looks better. As we want to estimate the dynamics of every single 
metabolite next let's think about what that means. We want to estimate the deviations
at every single time point from the metabolites mean over time. 
```{r,fig.align='center',fig.dpi=150}
# get time as numeric variable
intra$time <- gsub("h", "", intra$time)
intra$time <- as.numeric(intra$time)
intra <- intra %>% arrange(as.numeric(time))
ggplot(intra) +
  geom_line(aes(x = as.numeric(as.factor(time)), y = log_cpc, col = metabolite)) +
  theme_bw() +
  xlab("timepoint") +
  theme(legend.position = "none") +
  facet_grid(rows = vars(dose)) +
  ggtitle("raw metabolite dynamics", "col=metabolite")
```
As the concentrations of metabolites can differ by magnitudes from each other, 
we standardize each metabolite at each radiation dose to a mean of zero and a 
standard deviation of one. 
```{r,fig.align='center',fig.dpi=150}
intra <- intra %>%
  group_by(dose, metabolite) %>%
  mutate(log_cpc_stand = ((log_cpc - mean(log_cpc)) / sd(log_cpc)))
ggplot(intra) +
  geom_line(aes(x = as.numeric(as.factor(time)), y = log_cpc_stand, col = metabolite)) +
  theme_bw() +
  xlab("timepoint") +
  theme(legend.position = "none") +
  facet_grid(rows = vars(dose)) +
  ggtitle("standardized dynamics", "col=metabolite")
```
Now we can finally model the dynamics.

## Model dynamics
```{r,fig.align='center',fig.dpi=150}
# fit model
fits_dynamics <- fit_dynamics_model(data = intra[intra$dose=="0Gy",],
cpc = "log_cpc_stand", condition = "dose", max_treedepth = 14, adapt_delta = 0.999, iter = 4000, cores = 7)

# extract diagnostics
diagnostics_dynamics <- extract_diagnostics_dynamics(data=intra,iter=4000,fits=fits_dynamics)
diagnostics_dynamics[["plot_divergences"]]
diagnostics_dynamics[["plot_treedepth_error"]]
diagnostics_dynamics[["plot_rhat"]]
diagnostics_dynamics[["plot_neff"]]
diagnostics_dynamics[["plot_PCC_0Gy"]]

```
For our experimental dataset this might take up to 10 minutes per radiation dose
depending on how many cores are used. 

This returns a list of model fits that are named by the experimental condition
("0Gy","2Gy","10Gy"). With extract_diagnostics_dynamics() we can extract all
the diagnostic criteria of Bayesian models (rhat,neff,divergences,max_treedept)
and visualize them. Additionally dataframes for visual Posterior predictive 
checks (PPC) are prepared and Plots generated for the PPCs and diagnostic criteria.

After checking the diagnostic criteria and the PPC we can extract the estimates:

```{r,fig.align='center',fig.dpi=150}
# extract estimates
estimates_dynamics <- extract_estimates_dynamics(data=intra,fits=fits_dynamics,iter=4000)
# combine all three conditions in one dataframe
temp <- rbind(estimates_dynamics[[1]])#,estimates_dynamics[[2]],estimates_dynamics[[3]])
temp <- temp[,c(1:15)]
temp <- temp%>%pivot_longer(cols=c(mu1_mean,mu2_mean,mu3_mean,mu4_mean),names_to = "timepoint",values_to="mu_mean")
ggplot(temp,aes(x=as.factor(as.numeric(as.factor(timepoint))),y=mu_mean,group=metabolite.ID,col=metabolite))+
  geom_line()+
  xlab("timepoint")+
  ylab("estimated mean concentration")+
  theme_bw()+
  theme(legend.position = "none")+
  facet_grid(rows=vars(condition))+
  ggtitle("dynamics","color=metabolite")
  
```
We get two major outputs:
1) the estimation of concentration differences between two subsequent timepoints
  of each metabolite at each experimental condition
2) the dynamic profiles of each metabolites at each experimental condition

## 1) differences between two timepoints
```{r,fig.align='center',fig.dpi=150}
# 1) the differences between two timepoints
temp <- rbind(estimates_dynamics[[1]])#,estimates_dynamics[[2]],estimates_dynamics[[3]])
temp <- temp[,c(1:3,(6*t+7):(6*t+15))]
temp <- temp%>%pivot_longer(cols=-c(condition,metabolite.ID,metabolite),names_to=c("timepoints",".value"),names_sep = "_")
temp <- temp%>%  mutate(col=ifelse(higher<0,"HDI>0",
                                      ifelse(lower>0,"HDI<0","0inHDI")))
ggplot(temp,aes(x=as.numeric(mean),y=metabolite,col=col))+
  geom_point()+
  geom_errorbarh(aes(xmin=lower,xmax=higher))+
  xlab("delta")+
  scale_color_manual(values = c("black","green","red"), labels=c("0inCrI","CrI>0","CrI<0"),name="")+
  geom_vline(xintercept=0)+
  facet_grid(cols=vars(timepoints),rows=vars(condition))+
  theme_bw()+
  ggtitle("differences between timepoints")
```
If the 95% highest density interval of the posterior does not include zero
we can confidently stat that there is a difference in mean concentrations 
between two timepoints. If the 95% HDI is left of zero we have a decrease in
concentrations between the two timepoints, if it is right of zero we have an
increase in concentrations between timepoints. 

## 2) dynamic profiles
```{r,fig.align='center',fig.dpi=150}
# 2) dynamic profiles
temp <- rbind(estimates_dynamics[[1]])#,estimates_dynamics[[2]],estimates_dynamics[[3]])
temp <- temp%>%pivot_longer(cols=c(mu1.mean,mu2.mean,mu3.mean,mu4.mean),names_to = "timepoint",values_to="mu_mean")
ggplot(temp,aes(x=as.factor(as.numeric(as.factor(timepoint))),y=mu_mean,group=metabolite.ID,col=metabolite))+
  geom_line()+
  xlab("timepoint")+
  ylab("estimated mean concentration")+
  theme_bw()+
  theme(legend.position = "none")+
  facet_grid(rows=vars(condition))+
  ggtitle("dynamics","color=metabolite")
```
So we now have dynamic profiles of the metabolites at each radiation dose.
What do we do with this?

